#!/bin/bash
set -eou pipefail

vm_devbox_create_vm() {
    if [[ -e Vagrantfile ]]; then
        return
    fi
    curl 'https://radia.run' | vagrant_dev_vm_devbox=1 vagrant_dev_cpus=8 vagrant_dev_memory=8192 bash -s vagrant-sirepo-dev 'user-1.radia.run'
}

vm_devbox_main() {
    cd '/srv/vm_devbox_user-1'
    vm_devbox_create_vm
    vm_devbox_set_forwarded_port
    vm_devbox_set_ssh_config
}

vm_devbox_set_forwarded_port() {
    python <<'EOF'
import re
import subprocess

_FILE = "Vagrantfile"
_FORWARDED_PORT_PREAMBLE = 'config.vm.network "forwarded_port"'
_FORWARDED_PORT_FULL = (
    "{}, guest: 11110, host: 11110".format(
        _FORWARDED_PORT_PREAMBLE
    )
)
r = False
with open(_FILE) as f:
    c = f.read()
    if _FORWARDED_PORT_PREAMBLE not in c:
        c = re.sub(
            r"^\s*(config\.vm\.hostname.*)$",
            r"\1\n{}".format(_FORWARDED_PORT_FULL),
            c,
            flags=re.MULTILINE,
        )
        r = True
    elif _FORWARDED_PORT_FULL not in c:
        c = re.sub(
            r"^\s*{}.*$".format(_FORWARDED_PORT_PREAMBLE),
            _FORWARDED_PORT_FULL,
            c,
            flags=re.MULTILINE,
        )
        r = True
with open(_FILE, 'w') as f:
    f.write(c)
if r:
    subprocess.check_call(('vagrant', 'reload'))
EOF
}

vm_devbox_set_ssh_config() {
    if ! vagrant status | grep -q running; then
        vagrant up
    fi
    vagrant ssh <<'EOF'
sudo bash -s <<'EOF_BASH'
set -eou pipefail

install --mode=400 --owner=root --group=root /dev/stdin /etc/ssh/sshd_config<<EOF_SSH_CONFIG
# DO NOT EDIT THIS FILE
# MANAGED BY RSCONF

# Keep vagrant ssh working
Include /etc/ssh/sshd_config.d/*.conf

HostKey /etc/ssh/host_key
ListenAddress 0.0.0.0:11110

AuthorizedKeysFile .ssh/authorized_keys

AllowUsers vagrant
PasswordAuthentication no
PermitRootLogin no
Protocol 2
X11Forwarding yes

# For `vagrant ssh` and SSH access from local_ip
ListenAddress 0.0.0.0:22
# Allow passwords just for vagrant from local_ip (ex for sirepo.job_driver.sbatch)
Match User vagrant Address 127.0.0.1
    PasswordAuthentication yes
EOF_SSH_CONFIG
echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKe3wWXD3GUVd/5viGVhf6L/ttJJfmksXauPSpC8zWru v9.radia.run
' >> '/home/vagrant/.ssh/authorized_keys'

install --mode=400 --owner=root --group=root /dev/stdin "/etc/ssh/host_key"<<EOF_SSH_KEY
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACCT/PsL9/XcOTmEXAvGVhJj5+MlLl/UBUNDiC+H84AAHQAAAJBriK60a4iu
tAAAAAtzc2gtZWQyNTUxOQAAACCT/PsL9/XcOTmEXAvGVhJj5+MlLl/UBUNDiC+H84AAHQ
AAAEBVP+MksqPH64Pi3Rfb8lieY9ofTRBWZqvKWk2oYjuqsJP8+wv39dw5OYRcC8ZWEmPn
4yUuX9QFQ0OIL4fzgAAdAAAADHY5LnJhZGlhLnJ1bgE=
-----END OPENSSH PRIVATE KEY-----

EOF_SSH_KEY

passwd -d root
passwd -d vagrant

sshd -t
systemctl restart sshd
EOF_BASH
EOF
}

vm_devbox_main
