#!/bin/bash
set -eou pipefail

vm_devbox_first_start() {
    if [[ -e Vagrantfile ]]; then
        return
    fi
    curl 'https://radia.run' | vagrant_dev_private_net= \
        vagrant_dev_provision_eth1= \
        vagrant_dev_no_mounts=1 \
        vagrant_dev_no_nfs_src=1 \
        vagrant_dev_no_vbguest=1 \
        bash -s vagrant-sirepo-dev
}

vm_devbox_set_forwarded_port() {
    declare r=
    if ! grep -q 'forwarded_port' Vagrantfile; then
        perl -pi -e 's{^\s*(config.vm.hostname.*)$}{$1\nconfig.vm.network "forwarded_port", guest: 102002, host: 102002}' Vagrantfile
        r=1
    elif ! grep -q 'guest: 102002, host: 102002' Vagrantfile; then
        perl -pi -e 's{^\s*config.vm.network "forwarded_port"}{config.vm.network "forwarded_port", guest: 102002, host: 102002}' Vagrantfile
        r=1
    fi
    if [[ ${r:-} ]]; then
        vagrant reload
    fi
}

vm_devbox_set_ssh_config() {
    if ! vagrant status | grep -q running; then
        vagrant up
    fi
    vagrant ssh <<'EOF'
sudo bash -s <<'EOF_BASH'
set -eou pipefail

install --mode=400 --owner=root --group=root /dev/stdin /etc/sshd_config<<EOF_INSTALL
# DO NOT EDIT THIS FILE
# MANAGED BY RSCONF

# Keep vagrant ssh working
Include /etc/ssh/sshd_config.d/*.conf
ListenAddress 0.0.0.0:22

HostKey /etc/ssh/host_key
ListenAddress 0.0.0.0:102002

AuthorizedKeysFile .ssh/authorized_keys
PasswordAuthentication no
Protocol 2
X11Forwarding yes
EOF_INSTALL

echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKe3wWXD3GUVd/5viGVhf6L/ttJJfmksXauPSpC8zWru v9.radia.run
' >> '/home/vagrant/.ssh/authorized_keys'

install --mode=400 --owner=root --group=root /dev/stdin "/etc/ssh/host_key"<<EOF_INSTALL
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACCT/PsL9/XcOTmEXAvGVhJj5+MlLl/UBUNDiC+H84AAHQAAAJBriK60a4iu
tAAAAAtzc2gtZWQyNTUxOQAAACCT/PsL9/XcOTmEXAvGVhJj5+MlLl/UBUNDiC+H84AAHQ
AAAEBVP+MksqPH64Pi3Rfb8lieY9ofTRBWZqvKWk2oYjuqsJP8+wv39dw5OYRcC8ZWEmPn
4yUuX9QFQ0OIL4fzgAAdAAAADHY5LnJhZGlhLnJ1bgE=
-----END OPENSSH PRIVATE KEY-----

EOF_INSTALL

sshd -t
systemctl restart sshd
EOF_BASH
EOF
}

cd /srv/vm_devbox_joeblow/v
vm_devbox_create_vm
vm_devbox_set_forwarded_port
vm_devbox_set_ssh_config
